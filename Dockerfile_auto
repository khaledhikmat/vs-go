# Stage 1: Build Go app
FROM golang:latest as builder

WORKDIR /app
COPY . .
RUN go mod tidy && go build -o app main.go

# Stage 2: Runtime with OpenCV preinstalled
FROM opencv/opencv:4.8.0-contrib-ubuntu20.04

# Install GoCV runtime dependencies
RUN apt update && apt install -y ffmpeg libgstreamer1.0-0 libgstreamer-plugins-base1.0-0

# Copy compiled binary
COPY --from=builder /app/app /app/app

WORKDIR /app
ENV LD_LIBRARY_PATH=/usr/local/lib
CMD ["./app"]
