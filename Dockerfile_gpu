# ---------- STAGE 1: Build OpenCV + GoCV + Go app ----------
    FROM nvidia/cuda:12.2.0-devel-ubuntu22.04 AS builder

    # Install basic tools & dependencies
    RUN apt-get update && apt-get install -y \
        git cmake build-essential pkg-config \
        libgtk-3-dev libavcodec-dev libavformat-dev libswscale-dev \
        libjpeg-dev libpng-dev libtiff-dev libopenexr-dev libgdal-dev \
        libomp-dev wget unzip curl python3-dev python3-numpy && \
        wget https://go.dev/dl/go1.23.2.linux-amd64.tar.gz && \
        tar -C /usr/local -xzf go1.23.2.linux-amd64.tar.gz && \
        ln -s /usr/local/go/bin/go /usr/local/bin/go && \
        rm go1.23.2.linux-amd64.tar.gz && \
        rm -rf /var/lib/apt/lists/*
    
    # Build OpenCV from source with CUDA
    WORKDIR /opt
    RUN git clone https://github.com/opencv/opencv.git --branch 4.8.0 --depth 1 && \
        git clone https://github.com/opencv/opencv_contrib.git --branch 4.8.0 --depth 1
    
    WORKDIR /opt/opencv
    RUN mkdir build
    WORKDIR /opt/opencv/build
    
    RUN cmake -D CMAKE_BUILD_TYPE=Release \
        -D CMAKE_INSTALL_PREFIX=/usr/local \
        -D OPENCV_EXTRA_MODULES_PATH=/opt/opencv_contrib/modules \
        -D WITH_CUDA=ON \
        -D WITH_CUDNN=ON \
        -D OPENCV_DNN_CUDA=ON \
        -D BUILD_opencv_python3=OFF \
        -D BUILD_EXAMPLES=OFF \
        -D BUILD_TESTS=OFF \
        -D BUILD_PERF_TESTS=OFF \
        -D ENABLE_FAST_MATH=1 \
        -D CUDA_FAST_MATH=1 \
        -D WITH_CUBLAS=1 \
        -D BUILD_opencv_world=ON \
        .. && \
        make -j$(nproc) && \
        make install && \
        ldconfig
    
    # Clone GoCV and build
    WORKDIR /opt
    RUN git clone https://github.com/hybridgroup/gocv.git
    WORKDIR /opt/gocv
    RUN make install
    
    # Set environment variables
    ENV PKG_CONFIG_PATH=/usr/local/lib/pkgconfig
    ENV LD_LIBRARY_PATH=/usr/local/lib
    
    # Build your Go app
    WORKDIR /app
    COPY . .
    RUN go mod tidy && go build -o app main.go
    
    # ---------- STAGE 2: Slim runtime image ----------
    FROM nvidia/cuda:12.2.0-runtime-ubuntu22.04
    
    # Install runtime dependencies
    RUN apt-get update && apt-get install -y \
        libgtk-3-0 libavcodec58 libavformat58 libswscale5 \
        libjpeg-turbo8 libpng16-16 libtiff5 libopenexr25 libgdal30 \
        libomp5 libwebpdemux2 libtbb12 && \
        rm -rf /var/lib/apt/lists/*
    
    # Copy OpenCV + GoCV runtime libraries
    COPY --from=builder /usr/local /usr/local
    
    # Copy compiled Go app
    COPY --from=builder /app/app /app/app
    
    # Set environment variables
    ENV LD_LIBRARY_PATH=/usr/local/lib
    
    # Set working directory
    WORKDIR /app
    
    # Run the app
    CMD ["./app"]
    